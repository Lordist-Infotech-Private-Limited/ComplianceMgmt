<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Dashboard</title>
    <style>
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table, .table th, .table td {
            border: 1px solid black;
        }
        .table th, .table td {
            padding: 8px;
            text-align: center;
        }
        .expandable-row {
            display: none;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>

<h2>Dashboard</h2>

<!-- Reference Date and Fetch Data Button -->
<div>
    <label for="referenceDate">Reference Date:</label>
    <input type="date" id="referenceDate" name="referenceDate">
    <button onclick="fetchData()">Fetch Data</button>
</div>

<!-- Data Table -->
<table class="table" id="dataTable">
    <thead>
        <tr>
            <th>MSG Structure</th>
            <th>Total No of Records</th>
            <th>Success Records</th>
            <th>Constraint Rejection</th>
            <th>Business Rejection</th>
        </tr>
    </thead>
    <tbody id="tableBody">
        <!-- Rows will be inserted here dynamically -->
    </tbody>
</table>

<script>
    // Sample data array to be iterated
    const data = [];  // Will be populated by the POST call

    // Function to dynamically create rows based on data array
    function populateTable() {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';  // Clear existing rows

        data.forEach(item => {
            // Main row
            const mainRow = document.createElement('tr');
            mainRow.onclick = () => toggleExpandRow(mainRow);

            mainRow.innerHTML = `
                <td>${item.msgStructure}</td>
                <td>${item.totalRecords}</td>
                <td>+${item.successRecords}</td>
                <td>+${item.constraintRejection}</td>
                <td>+${item.businessRejection}</td>
            `;

            // Expandable row
            const expandableRow = document.createElement('tr');
            expandableRow.className = 'expandable-row';
            expandableRow.innerHTML = `
                <td colspan="5">
                    <div class="expanded-content">
                        <label for="pageSize">Page Size:</label>
                        <select>
                            <option>10</option>
                            <option>20</option>
                            <option>50</option>
                        </select>
                        <button>Download</button>
                        <button>Upload</button>
                        <label for="rejectionReason">Rejection Reason:</label>
                        <input type="text" placeholder="Rejection Reason">
                        <input type="text" placeholder="Search...">
                    </div>
                </td>
            `;

            // Append both rows to the table body
            tableBody.appendChild(mainRow);
            tableBody.appendChild(expandableRow);
        });
    }

    async function fetchData() {
    const referenceDate = document.getElementById('referenceDate').value;
    const tableName = 'stgborrowerdetail'; // You can dynamically get this from elsewhere in your UI if needed.
    console.log('Fetching data for date:', referenceDate);
    
    // Properly encode the URL parameters
    const url = `https://localhost:7275/Dashboard/GetRecordCount?date=${encodeURIComponent(referenceDate)}&tableName=${encodeURIComponent(tableName)}`;
    
    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`Error: ${response.statusText}`);
        }

        const result = await response.json();
        data.length = 0;  // Clear current data
        data.push(...result);  // Populate the data array with the response
        populateTable();  // Populate the table with new data

    } catch (error) {
        console.error('Error fetching data:', error);
    }
}

    function toggleExpandRow(row) {
        // Get the next row which is the expandable row
        const expandedRow = row.nextElementSibling;

        // Toggle the display of the expandable row
        expandedRow.style.display = expandedRow.style.display === "table-row" ? "none" : "table-row";
    }

    // Initial population of the table
    populateTable();
</script>

</body>
</html>
